# Microsoft Sentinel (SIEM) Attack Map
The purpose of this lab is to utilize Microsoft Sentinel (SIEM) in order to keep track of unsuccessful RDP login attempts made by attackers from around the world on a Windows 10 virtual machine (VM) that has been exposed and set up in Microsoft Azure.

## Overview
- Microsoft Sentinel (SIEM) was used to monitor failed RDP login attempts from global attackers on an exposed Windows 10 VM configured in Microsoft Azure.
- A custom log file (`failed_rdp.log`) was generated using a PowerShell script that extracts failed login events from Event Viewer Security Log and forwards them to a third-party API to get geolocation data.
- A custom table (`FAILED_RDP_WITH_GEO_CL`) was created in Log Analytics Workspace on Microsoft Azure using the generated log file (`failed_rdp.log`), and the table was queried to extract custom fields from RawData using Kusto Query Language (KQL).
- A workbook was created in Microsoft Sentinel (SIEM) using KQL to query data from the `FAILED_RDP_WITH_GEO_CL` table to display global attackers (RDP login failure) on the world map according to physical location and magnitude (attack count).

The procedures to build this lab can be found [here](https://github.com/robsann/AzureSentinelSIEMAttackMap/blob/main/procedure.md), and it was adapted from [Josh Madakor](https://www.youtube.com/watch?v=RoZeVbbZ0o0&t=1544s&ab_channel=JoshMadakor-Tech%2CEducation%2CCareer).

## Lab Diagram
<img src="images/diagram.png" title="Lab Diagram"/>

# Highlighs
## 1 - The Virtual Machine on Microsoft Azure
### 1.1 - Windows 10 VM on Microsoft Azure
Here is the information about the Windows 10 virtual machine that has been created and named "honeypot-vm". This includes property details such as the computer name, operating system, public and private IP addresses, as well as the hardware being used. Furthermore, the virtual machine can be accessed via RDP.

<img src="images/1-honeypot-vm.png" title="honepot-vm"/>

### 1.2 - Windows Defender Firewall disabled
The Windows Defender Firewall of the Windows 10 virtual machine was turned off for the Domain, Private, and Public profiles.

<img src="images/2-windows-firewall.png" title="Windows Defender Firewall"/>

## 2 - The PowerShell script

### 2.1 - Main sections of the PowerShell script

#### XML filter
The PowerShell script uses it to filter events with ID = 4625 on Event Viewer.

<img src="images/3a-xml-filter.png" title="XML filter"/>

#### Event Viewer log gathering
This section of the code retrieves events from the Windows Event Viewer based on the XML filter.

<img src="images/3b-event-viwer-log-gather.png" title="Event Viwer log gather"/>

#### API data gathering
Use the IP address extracted from Event Viewer to make web requests to the geolocation API.

<img src="images/3c-api-data-gather.png" title="API data gather"/>


### 2.2 - Failed login attempts extracted with PowerShell script
The PowerShell ISE shows the PowerShell script created to extract failed login attempts from Event Viewer running and outputting to the terminal the detected failed login attempts.

<img src="images/3-powershell-script.png" title="PowerShell script + Event Viwer"/>

### 2.3 - The Cutom Log File (`failed_rdp.log`)
This text file shows the custom log file generated by the PowerShell script. It has information about the failed RDP login attempt like the username attempted and the source IP address, and also geolocation data from the IP address. It is the file that is ingested by Log Analytics Workspace on Microsoft Azure.

<img src="images/3d-failed_rdp.log.png" title="Failed RDP Log"/>

### 3 - Log Analytics Workspace Custom Table
The data from the table `FAILED_RDP_WITH_GEO_CL` was queried using KQL. The table was created using `failed_rdp.log` imported in real-time from the VM.

<img src="images/4-law-honeypot1-logs.png" title="law-honeypot1-logs"/>

### 4 - Microsoft Sentinal Map
Visualization of failed RDP login attempts on a world map. The latitude and longitude data were obtained from the `FAILED_RDP_WITH_GEO_CL` table using KQL queries.

#### 4.1 - After 1 hour of exposure.
During the first hour, two failed RDP login attempts were registered from me and three from the United Kingdom.

<img src="images/5a-sentinel-map-1h.png" title="Sentinel map 1h"/>

#### 4.2 - After 24 hours of exposure
After 24 hours of exposure, the virtual machine had 844 failed RDP login attempts from India, 447 from Palestine, 338 from Japan, and 533 from other countries.

<img src="images/5b-sentinel-map-24h.png" title="Sentinel map 24h"/>

#### 4.3 - After 48 hours of exposure
Over a 48-hour period, there were a significant number of failed RDP login attempts on the virtual machine, originating from various countries. There were 1.75k failed attempts from Netherlands, 1.05 from Pakistan, 844 from India, and 3.09k from other countries.

<img src="images/5c-sentinel-map-48h.png" title="Sentinel map 48h"/>

#### 4.4 - Top 10 usernames used by attackers.
This bar plot displays the top 10 usernames most frequently used by attackers, obtained from the `FAILED_RDP_WITH_GEO_CL` table through KQL queries. The most commonly used username is `ADMINISTRATOR`, followed by `ADMIN`, `administrator`, `Administrator`, and `admin`.

<img src="images/6-TopUsernames.png" title="Top 10 Usernames"/>
